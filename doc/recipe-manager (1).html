<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ãƒ¬ã‚·ãƒ”ç®¡ç†">
    <title>ãƒ¬ã‚·ãƒ”ç®¡ç†å¸³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 999;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-selector select {
            border: none;
            background: transparent;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 8px;
            font-weight: bold;
        }

        .language-selector select:focus {
            outline: none;
        }

        .debug-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 12px;
            z-index: 998;
        }

        .debug-info button {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 11px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
        }

        select:hover, button:hover {
            border-color: #3498db;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            font-weight: bold;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .recipe-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .recipe-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .recipe-card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .recipe-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #7f8c8d;
        }

        .recipe-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .category-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tag {
            background: #ecf0f1;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: #555;
        }

        .serving-adjuster {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 12px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .serving-adjuster button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #3498db;
            background: white;
            color: #3498db;
            font-weight: bold;
            padding: 0;
        }

        .serving-adjuster button:hover {
            background: #3498db;
            color: white;
        }

        .card-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .card-buttons button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 30px auto;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            background: #3498db;
            color: white;
            padding: 20px 25px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            line-height: 1;
        }

        .modal-body {
            padding: 25px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .ingredient-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ingredient-item {
            display: flex;
            gap: 10px;
        }

        .ingredient-item input {
            flex: 1;
        }

        .ingredient-item button {
            width: 35px;
            height: 35px;
            padding: 0;
            background: #e74c3c;
            color: white;
            border: none;
        }

        .add-ingredient-btn {
            margin-top: 10px;
            background: #27ae60;
            color: white;
            border: none;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: normal;
        }

        .recipe-detail {
            line-height: 1.8;
        }

        .recipe-detail h4 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-size: 16px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }

        .recipe-detail .ingredients-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .recipe-detail .ingredients-list li {
            margin-bottom: 5px;
            list-style-position: inside;
        }

        .recipe-detail .steps-list {
            counter-reset: step-counter;
        }

        .recipe-detail .steps-list li {
            counter-increment: step-counter;
            margin-bottom: 12px;
            padding-left: 35px;
            position: relative;
        }

        .recipe-detail .steps-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .notes-section {
            background: #fff9e6;
            border: 2px dashed #f39c12;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .notes-section textarea {
            width: 100%;
            border: none;
            background: transparent;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state p {
            font-size: 18px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .language-selector {
                top: 10px;
                right: 10px;
                font-size: 12px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 22px;
                margin-bottom: 15px;
            }

            .recipe-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                gap: 10px;
            }

            .search-box {
                width: 100%;
            }

            .filter-group {
                width: 100%;
                flex-direction: column;
            }

            .filter-group select,
            .filter-group button {
                width: 100%;
            }

            .modal-content {
                margin: 10px;
                max-width: calc(100% - 20px);
            }

            .modal-body {
                max-height: calc(100vh - 150px);
            }

            .ingredient-item {
                flex-direction: column;
            }

            .ingredient-item input {
                width: 100%;
            }

            .ingredient-item button {
                width: 100%;
            }

            .card-buttons {
                flex-direction: column;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        ğŸŒ <select id="languageSelect" onchange="changeLanguage()">
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="en">English</option>
        </select>
    </div>

    <!-- Debug Panel (ä¸€æ™‚çš„ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨) -->
    <div class="debug-info" id="debugPanel" style="display: none;">
        <div>ãƒ¬ã‚·ãƒ”æ•°: <span id="recipeCount">0</span></div>
        <button onclick="showRecipeData()">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
        <button onclick="fixAllRecipes()">ãƒ‡ãƒ¼ã‚¿ä¿®å¾©</button>
        <button onclick="document.getElementById('debugPanel').style.display='none'">é–‰ã˜ã‚‹</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 data-i18n="title">ğŸ³ ãƒ¬ã‚·ãƒ”ç®¡ç†å¸³</h1>
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢...">
                </div>
                <div class="filter-group">
                    <select id="categoryFilter">
                        <option value="" data-i18n="allCategories">å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
                        <option value="å’Œé£Ÿ" data-i18n="japanese">å’Œé£Ÿ</option>
                        <option value="æ´‹é£Ÿ" data-i18n="western">æ´‹é£Ÿ</option>
                        <option value="ä¸­è¯" data-i18n="chinese">ä¸­è¯</option>
                        <option value="ãƒ‡ã‚¶ãƒ¼ãƒˆ" data-i18n="dessert">ãƒ‡ã‚¶ãƒ¼ãƒˆ</option>
                        <option value="ãã®ä»–" data-i18n="other">ãã®ä»–</option>
                    </select>
                    <select id="seasonFilter">
                        <option value="" data-i18n="allSeasons">å…¨å­£ç¯€</option>
                        <option value="æ˜¥" data-i18n="spring">æ˜¥</option>
                        <option value="å¤" data-i18n="summer">å¤</option>
                        <option value="ç§‹" data-i18n="fall">ç§‹</option>
                        <option value="å†¬" data-i18n="winter">å†¬</option>
                        <option value="é€šå¹´" data-i18n="yearRound">é€šå¹´</option>
                    </select>
                    <select id="eventFilter">
                        <option value="" data-i18n="allEvents">å…¨ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                        <option value="ãŠæ­£æœˆ" data-i18n="newYear">ãŠæ­£æœˆ</option>
                        <option value="ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³" data-i18n="valentine">ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³</option>
                        <option value="ã²ãªç¥­ã‚Š" data-i18n="hinamatsuri">ã²ãªç¥­ã‚Š</option>
                        <option value="ãƒãƒ­ã‚¦ã‚£ãƒ³" data-i18n="halloween">ãƒãƒ­ã‚¦ã‚£ãƒ³</option>
                        <option value="ã‚¯ãƒªã‚¹ãƒã‚¹" data-i18n="christmas">ã‚¯ãƒªã‚¹ãƒã‚¹</option>
                        <option value="èª•ç”Ÿæ—¥" data-i18n="birthday">èª•ç”Ÿæ—¥</option>
                        <option value="ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼" data-i18n="party">ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</option>
                        <option value="æ™®æ®µ" data-i18n="everyday">æ™®æ®µ</option>
                    </select>
                    <button class="btn-primary" onclick="openAddModal()" data-i18n="newRecipe">+ æ–°è¦ãƒ¬ã‚·ãƒ”</button>
                    <button class="btn-primary" onclick="openImportModal()" style="background: #27ae60;" data-i18n="importUrl">ğŸ”— URLã‹ã‚‰å–è¾¼</button>
                    <button class="btn-primary" onclick="openTextImportModal()" style="background: #9b59b6;" data-i18n="importText">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–è¾¼</button>
                    <button class="btn-primary" onclick="openPhotoImportModal()" style="background: #e67e22;" data-i18n="importPhoto">ğŸ“· å†™çœŸã‹ã‚‰å–è¾¼</button>
                    <button class="btn-primary" onclick="exportRecipes()" style="background: #f39c12;" data-i18n="exportData">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸å‡º</button>
                    <button class="btn-primary" onclick="document.getElementById('importDataFile').click()" style="background: #16a085;" data-i18n="importData">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼</button>
                    <input type="file" id="importDataFile" accept=".json" style="display: none;" onchange="importRecipes(event)">
                </div>
            </div>
        </div>

        <div id="recipeGrid" class="recipe-grid"></div>
    </div>

    <!-- ãƒ¬ã‚·ãƒ”è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°è¦ãƒ¬ã‚·ãƒ”</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="recipeForm">
                    <div class="form-group">
                        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="recipeTitle" required>
                    </div>

                    <div class="form-group">
                        <label>åˆ†é‡ãƒ»ã§ãã‚ãŒã‚Šé‡</label>
                        <input type="text" id="recipeYield" placeholder="ä¾‹: 4äººåˆ†ã€2æœ¬ã€12å€‹ã€1ãƒ›ãƒ¼ãƒ«" required>
                        <small style="color: #7f8c8d; font-size: 12px;">äººæ•°ã€å€‹æ•°ã€æœ¬æ•°ãªã©è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™</small>
                    </div>

                    <div class="form-group">
                        <label>1äººåˆ†ã®ã‚«ãƒ­ãƒªãƒ¼ï¼ˆä»»æ„ï¼‰</label>
                        <input type="number" id="caloriesPerServing" min="0" placeholder="ä¾‹: 350">
                        <small style="color: #7f8c8d; font-size: 12px;">å¤•é£Ÿãƒ¬ã‚·ãƒ”ãªã©äººæ•°åˆ†ã®ãƒ¬ã‚·ãƒ”ã«ä½¿ç”¨</small>
                    </div>

                    <div class="form-group">
                        <label>èª¿ç†æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                        <input type="number" id="cookingTime" min="1" required>
                    </div>

                    <div class="form-group">
                        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="category" value="å’Œé£Ÿ"> å’Œé£Ÿ</label>
                            <label><input type="checkbox" name="category" value="æ´‹é£Ÿ"> æ´‹é£Ÿ</label>
                            <label><input type="checkbox" name="category" value="ä¸­è¯"> ä¸­è¯</label>
                            <label><input type="checkbox" name="category" value="ãƒ‡ã‚¶ãƒ¼ãƒˆ"> ãƒ‡ã‚¶ãƒ¼ãƒˆ</label>
                            <label><input type="checkbox" name="category" value="ãã®ä»–"> ãã®ä»–</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å­£ç¯€</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="season" value="æ˜¥"> æ˜¥</label>
                            <label><input type="checkbox" name="season" value="å¤"> å¤</label>
                            <label><input type="checkbox" name="season" value="ç§‹"> ç§‹</label>
                            <label><input type="checkbox" name="season" value="å†¬"> å†¬</label>
                            <label><input type="checkbox" name="season" value="é€šå¹´"> é€šå¹´</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆ</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="event" value="ãŠæ­£æœˆ"> ãŠæ­£æœˆ</label>
                            <label><input type="checkbox" name="event" value="ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³"> ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³</label>
                            <label><input type="checkbox" name="event" value="ã²ãªç¥­ã‚Š"> ã²ãªç¥­ã‚Š</label>
                            <label><input type="checkbox" name="event" value="ãƒãƒ­ã‚¦ã‚£ãƒ³"> ãƒãƒ­ã‚¦ã‚£ãƒ³</label>
                            <label><input type="checkbox" name="event" value="ã‚¯ãƒªã‚¹ãƒã‚¹"> ã‚¯ãƒªã‚¹ãƒã‚¹</label>
                            <label><input type="checkbox" name="event" value="èª•ç”Ÿæ—¥"> èª•ç”Ÿæ—¥</label>
                            <label><input type="checkbox" name="event" value="ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼"> ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</label>
                            <label><input type="checkbox" name="event" value="æ™®æ®µ"> æ™®æ®µ</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ææ–™ï¼ˆä¾‹ï¼š2 cups flourï¼‰</label>
                        <div id="ingredientsList" class="ingredient-list"></div>
                        <button type="button" class="add-ingredient-btn" onclick="addIngredientField()">+ ææ–™ã‚’è¿½åŠ </button>
                    </div>

                    <div class="form-group">
                        <label>ä½œã‚Šæ–¹ï¼ˆ1è¡Œã«1ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</label>
                        <textarea id="instructions" required placeholder="å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ”¹è¡Œã§åŒºåˆ‡ã£ã¦ãã ã•ã„"></textarea>
                    </div>

                    <div class="form-group">
                        <label>å†™çœŸURLï¼ˆä»»æ„ï¼‰</label>
                        <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn-primary" style="width: 100%; padding: 12px;">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ¬ã‚·ãƒ”è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailTitle"></h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detailContent" class="recipe-detail"></div>
            </div>
        </div>
    </div>

    <!-- URLã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: #27ae60;">
                <h2>ğŸ”— URLã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚’å–è¾¼</h2>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ãƒ¬ã‚·ãƒ”ãƒšãƒ¼ã‚¸ã®URL</label>
                    <input type="url" id="importUrl" placeholder="https://example.com/recipe" style="margin-bottom: 10px;">
                    <button onclick="fetchRecipeFromUrl()" class="btn-primary" style="width: 100%; background: #27ae60;">å–ã‚Šè¾¼ã‚€</button>
                </div>
                <div id="importStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                <div id="importPreview" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="textImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: #9b59b6;">
                <h2>ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚’å–è¾¼</h2>
                <button class="close-btn" onclick="closeTextImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</label>
                    <textarea id="importText" 
                              placeholder="LINEãƒ¡ãƒ¢ãªã©ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸãƒ¬ã‚·ãƒ”ãƒ†ã‚­ã‚¹ãƒˆã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
ãƒã‚­ãƒ³ã‚«ãƒ¬ãƒ¼
4äººåˆ†ã€èª¿ç†æ™‚é–“45åˆ†

ææ–™ï¼š
é¶ã‚‚ã‚‚è‚‰ 400g
ç‰ã­ã 2å€‹
ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼ 4ç‰‡
...

ä½œã‚Šæ–¹ï¼š
1. ç‰ã­ãã‚’ã¿ã˜ã‚“åˆ‡ã‚Šã«ã™ã‚‹
2. é¶è‚‰ã‚’ä¸€å£å¤§ã«åˆ‡ã‚‹
..." 
                              style="min-height: 300px; font-family: monospace;"></textarea>
                    <button onclick="parseRecipeFromText()" class="btn-primary" style="width: 100%; margin-top: 10px; background: #9b59b6;">
                        è§£æã—ã¦å–ã‚Šè¾¼ã‚€
                    </button>
                </div>
                <div id="textImportStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                <div id="textImportPreview" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- å†™çœŸã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="photoImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: #e67e22;">
                <h2>ğŸ“· å†™çœŸã‹ã‚‰ãƒ¬ã‚·ãƒ”ã‚’å–è¾¼</h2>
                <button class="close-btn" onclick="closePhotoImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ‰‹æ›¸ããƒ¬ã‚·ãƒ”ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                    <input type="file" id="photoInput" accept="image/*" style="width: 100%; padding: 10px; border: 2px dashed #e67e22; border-radius: 8px; cursor: pointer;">
                    <small style="color: #7f8c8d; font-size: 12px; display: block; margin-top: 8px;">
                        æ‰‹æ›¸ãã®ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã€ãƒãƒ¼ãƒˆã€ãƒ¡ãƒ¢ãªã©ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </small>
                    <div id="photoPreviewContainer" style="margin-top: 15px; display: none;">
                        <img id="photoPreview" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #ddd;">
                    </div>
                    <button onclick="parseRecipeFromPhoto()" class="btn-primary" style="width: 100%; margin-top: 10px; background: #e67e22;">
                        å†™çœŸã‚’è§£æã—ã¦å–ã‚Šè¾¼ã‚€
                    </button>
                </div>
                <div id="photoImportStatus" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>
                <div id="photoImportPreview" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Translation system
        const translations = {
            ja: {
                title: 'ğŸ³ ãƒ¬ã‚·ãƒ”ç®¡ç†å¸³',
                searchPlaceholder: 'ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢...',
                allCategories: 'å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼',
                japanese: 'å’Œé£Ÿ',
                western: 'æ´‹é£Ÿ',
                chinese: 'ä¸­è¯',
                dessert: 'ãƒ‡ã‚¶ãƒ¼ãƒˆ',
                other: 'ãã®ä»–',
                allSeasons: 'å…¨å­£ç¯€',
                spring: 'æ˜¥',
                summer: 'å¤',
                fall: 'ç§‹',
                winter: 'å†¬',
                yearRound: 'é€šå¹´',
                allEvents: 'å…¨ã‚¤ãƒ™ãƒ³ãƒˆ',
                newYear: 'ãŠæ­£æœˆ',
                valentine: 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³',
                hinamatsuri: 'ã²ãªç¥­ã‚Š',
                halloween: 'ãƒãƒ­ã‚¦ã‚£ãƒ³',
                christmas: 'ã‚¯ãƒªã‚¹ãƒã‚¹',
                birthday: 'èª•ç”Ÿæ—¥',
                party: 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼',
                everyday: 'æ™®æ®µ',
                newRecipe: '+ æ–°è¦ãƒ¬ã‚·ãƒ”',
                importUrl: 'ğŸ”— URLã‹ã‚‰å–è¾¼',
                importText: 'ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–è¾¼',
                importPhoto: 'ğŸ“· å†™çœŸã‹ã‚‰å–è¾¼',
                exportData: 'ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸å‡º',
                importData: 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼',
                recipeTitle: 'ã‚¿ã‚¤ãƒˆãƒ«',
                yieldAmount: 'åˆ†é‡ãƒ»ã§ãã‚ãŒã‚Šé‡',
                cookingTime: 'èª¿ç†æ™‚é–“ï¼ˆåˆ†ï¼‰',
                category: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼',
                season: 'å­£ç¯€',
                event: 'ã‚¤ãƒ™ãƒ³ãƒˆ',
                ingredients: 'ææ–™',
                instructions: 'ä½œã‚Šæ–¹',
                imageUrl: 'å†™çœŸURLï¼ˆä»»æ„ï¼‰',
                save: 'ä¿å­˜',
                detail: 'è©³ç´°',
                edit: 'ç·¨é›†',
                delete: 'å‰Šé™¤',
                close: 'é–‰ã˜ã‚‹',
                minutes: 'åˆ†',
                emptyState: 'ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                notes: 'ãƒ¡ãƒ¢',
                saveNotes: 'ãƒ¡ãƒ¢ã‚’ä¿å­˜',
                sourceRecipe: 'å…ƒã®ãƒ¬ã‚·ãƒ”',
                yieldPlaceholder: 'ä¾‹: 4äººåˆ†ã€2æœ¬ã€12å€‹ã€1ãƒ›ãƒ¼ãƒ«',
                yieldHelper: 'äººæ•°ã€å€‹æ•°ã€æœ¬æ•°ãªã©è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™'
            },
            en: {
                title: 'ğŸ³ Recipe Manager',
                searchPlaceholder: 'Search recipes...',
                allCategories: 'All Categories',
                japanese: 'Japanese',
                western: 'Western',
                chinese: 'Chinese',
                dessert: 'Dessert',
                other: 'Other',
                allSeasons: 'All Seasons',
                spring: 'Spring',
                summer: 'Summer',
                fall: 'Fall',
                winter: 'Winter',
                yearRound: 'Year-round',
                allEvents: 'All Events',
                newYear: 'New Year',
                valentine: 'Valentine',
                hinamatsuri: 'Hinamatsuri',
                halloween: 'Halloween',
                christmas: 'Christmas',
                birthday: 'Birthday',
                party: 'Party',
                everyday: 'Everyday',
                newRecipe: '+ New Recipe',
                importUrl: 'ğŸ”— Import from URL',
                importText: 'ğŸ“ Import from Text',
                importPhoto: 'ğŸ“· Import from Photo',
                exportData: 'ğŸ“¤ Export Data',
                importData: 'ğŸ“¥ Import Data',
                recipeTitle: 'Title',
                yieldAmount: 'Yield / Amount',
                cookingTime: 'Cooking Time (minutes)',
                category: 'Category',
                season: 'Season',
                event: 'Event',
                ingredients: 'Ingredients',
                instructions: 'Instructions',
                imageUrl: 'Image URL (optional)',
                save: 'Save',
                detail: 'Details',
                edit: 'Edit',
                delete: 'Delete',
                close: 'Close',
                minutes: 'min',
                emptyState: 'No recipes found',
                notes: 'Notes',
                saveNotes: 'Save Notes',
                sourceRecipe: 'Source Recipe',
                yieldPlaceholder: 'e.g., 4 servings, 2 loaves, 12 cookies',
                yieldHelper: 'Enter servings, quantity, or amount freely'
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'ja';

        function changeLanguage() {
            currentLanguage = document.getElementById('languageSelect').value;
            localStorage.setItem('language', currentLanguage);
            applyTranslations();
            renderRecipes();
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function applyTranslations() {
            // Translate elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (element.tagName === 'OPTION') {
                    element.textContent = t(key);
                } else {
                    element.innerHTML = t(key);
                }
            });

            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
        }

        let recipes = JSON.parse(localStorage.getItem('recipes')) || [];
        let editingId = null;
        let titleTranslationCache = {}; // Cache for translated titles

        // Load translation cache
        function loadTranslationCache() {
            const cached = localStorage.getItem('titleTranslationCache');
            if (cached) {
                titleTranslationCache = JSON.parse(cached);
            }
        }

        function saveTranslationCache() {
            localStorage.setItem('titleTranslationCache', JSON.stringify(titleTranslationCache));
        }

        loadTranslationCache();

        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼šå¤ã„ãƒ¬ã‚·ãƒ”ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›
        function migrateOldRecipes() {
            let migrated = false;
            recipes = recipes.map(recipe => {
                // yield ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å¤ã„ãƒ¬ã‚·ãƒ”ã‚’å¤‰æ›
                if (!recipe.yield && recipe.baseServings) {
                    migrated = true;
                    return {
                        ...recipe,
                        yield: `${recipe.baseServings}äººåˆ†`,
                        caloriesPerServing: recipe.caloriesPerServing || null
                    };
                }
                // caloriesPerServing ãŒãªã„å ´åˆã¯è¿½åŠ 
                if (recipe.caloriesPerServing === undefined) {
                    migrated = true;
                    return {
                        ...recipe,
                        caloriesPerServing: null
                    };
                }
                return recipe;
            });

            if (migrated) {
                saveRecipes();
                console.log('ãƒ¬ã‚·ãƒ”ã‚’æ–°ã—ã„å½¢å¼ã«ç§»è¡Œã—ã¾ã—ãŸ');
            }
        }

        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å®Ÿè¡Œ
        migrateOldRecipes();

        function showRecipeData() {
            console.log('å…¨ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿:', recipes);
            recipes.forEach((recipe, index) => {
                console.log(`ãƒ¬ã‚·ãƒ” ${index + 1}:`, {
                    id: recipe.id,
                    title: recipe.title,
                    yield: recipe.yield,
                    baseServings: recipe.baseServings,
                    hasYield: !!recipe.yield,
                    hasCalories: !!recipe.caloriesPerServing
                });
            });
            alert(`${recipes.length}å€‹ã®ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }

        function fixAllRecipes() {
            const message = currentLanguage === 'ja' 
                ? 'å…¨ã¦ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®å¾©ã—ã¾ã™ã‹ï¼Ÿ' 
                : 'Fix all recipe data?';
            
            if (confirm(message)) {
                recipes = recipes.map(recipe => ({
                    ...recipe,
                    yield: recipe.yield || `${recipe.baseServings || 4}äººåˆ†`,
                    baseServings: recipe.baseServings || extractServingsNumber(recipe.yield || '4äººåˆ†'),
                    caloriesPerServing: recipe.caloriesPerServing || null,
                    categories: recipe.categories || ['ãã®ä»–'],
                    seasons: recipe.seasons || ['é€šå¹´'],
                    events: recipe.events || ['æ™®æ®µ'],
                    ingredients: recipe.ingredients || [],
                    instructions: recipe.instructions || [],
                    imageUrl: recipe.imageUrl || '',
                    sourceUrl: recipe.sourceUrl || '',
                    notes: recipe.notes || '',
                    cookingTime: recipe.cookingTime || 30
                }));
                
                saveRecipes();
                renderRecipes();
                alert(currentLanguage === 'ja' ? 'ä¿®å¾©å®Œäº†ï¼' : 'Fixed!');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆCtrl+Shift+Dï¼‰
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const panel = document.getElementById('debugPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                document.getElementById('recipeCount').textContent = recipes.length;
            }
        });

        function saveRecipes() {
            localStorage.setItem('recipes', JSON.stringify(recipes));
        }

        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'æ–°è¦ãƒ¬ã‚·ãƒ”';
            document.getElementById('recipeForm').reset();
            document.getElementById('ingredientsList').innerHTML = '';
            addIngredientField();
            addIngredientField();
            addIngredientField();
            document.getElementById('recipeModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('recipeModal').style.display = 'none';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function openImportModal() {
            document.getElementById('importUrl').value = '';
            document.getElementById('importStatus').style.display = 'none';
            document.getElementById('importPreview').innerHTML = '';
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function openTextImportModal() {
            document.getElementById('importText').value = '';
            document.getElementById('textImportStatus').style.display = 'none';
            document.getElementById('textImportPreview').innerHTML = '';
            document.getElementById('textImportModal').style.display = 'block';
        }

        function closeTextImportModal() {
            document.getElementById('textImportModal').style.display = 'none';
        }

        function openPhotoImportModal() {
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreviewContainer').style.display = 'none';
            document.getElementById('photoImportStatus').style.display = 'none';
            document.getElementById('photoImportPreview').innerHTML = '';
            document.getElementById('photoImportModal').style.display = 'block';
        }

        function closePhotoImportModal() {
            document.getElementById('photoImportModal').style.display = 'none';
        }

        // Photo preview when file is selected
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('photoPreview').src = e.target.result;
                            document.getElementById('photoPreviewContainer').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        async function parseRecipeFromPhoto() {
            const fileInput = document.getElementById('photoInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showPhotoImportStatus(currentLanguage === 'ja' ? 'å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„' : 'Please select a photo', 'error');
                return;
            }

            showPhotoImportStatus(currentLanguage === 'ja' ? 'å†™çœŸã‚’è§£æä¸­...' : 'Analyzing photo...', 'loading');

            try {
                // Convert image to base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(",")[1];
                        resolve(base64);
                    };
                    reader.onerror = () => reject(new Error("Failed to read file"));
                    reader.readAsDataURL(file);
                });

                // Detect image type
                const imageType = file.type;

                const response = await fetch(`https://api.anthropic.com/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: imageType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    content: `ã“ã®ç”»åƒã¯æ‰‹æ›¸ãã®ãƒ¬ã‚·ãƒ”ã§ã™ã€‚ç”»åƒã‹ã‚‰ãƒ¬ã‚·ãƒ”æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆä»–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ï¼‰ï¼š
{
  "title": "ãƒ¬ã‚·ãƒ”ã®ã‚¿ã‚¤ãƒˆãƒ«",
  "yield": "åˆ†é‡ã‚„å€‹æ•°ï¼ˆä¾‹: 4äººåˆ†ã€2æœ¬ã€12å€‹ï¼‰",
  "cookingTime": èª¿ç†æ™‚é–“ï¼ˆåˆ†ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯30ï¼‰,
  "caloriesPerServing": 1äººåˆ†ã¾ãŸã¯1å€‹ã‚ãŸã‚Šã®ã‚«ãƒ­ãƒªãƒ¼ï¼ˆæ•°å­—ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯nullï¼‰,
  "ingredients": ["ææ–™1 åˆ†é‡ä»˜ã", "ææ–™2 åˆ†é‡ä»˜ã", ...],
  "instructions": ["æ‰‹é †1", "æ‰‹é †2", ...],
  "categories": ["å’Œé£Ÿ"ã¾ãŸã¯"æ´‹é£Ÿ"ã¾ãŸã¯"ä¸­è¯"ã¾ãŸã¯"ãƒ‡ã‚¶ãƒ¼ãƒˆ"ã¾ãŸã¯"ãã®ä»–"ã®ã„ãšã‚Œã‹],
  "detectedInfo": "èª­ã¿å–ã‚Šã®å“è³ªã‚„æ³¨æ„ç‚¹"
}

é‡è¦ãªæ³¨æ„äº‹é …ï¼š
- æ‰‹æ›¸ãæ–‡å­—ã‚’ã§ãã‚‹é™ã‚Šæ­£ç¢ºã«èª­ã¿å–ã£ã¦ãã ã•ã„
- èª­ã¿ã«ãã„éƒ¨åˆ†ã¯æ¨æ¸¬ã—ã¦è£œå®Œã—ã¦ãã ã•ã„
- ææ–™ã¯åˆ†é‡ã¨ä¸€ç·’ã«æŠ½å‡ºã—ã¦ãã ã•ã„
- æ‰‹é †ã¯ç•ªå·é †ã«æ•´ç†ã—ã¦ãã ã•ã„
- JSONã®ã¿ã‚’è¿”ã—ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚„èª¬æ˜æ–‡ã¯å«ã‚ãªã„ã§ãã ã•ã„`
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('å†™çœŸã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const data = await response.json();
                let recipeText = data.content[0].text;
                
                recipeText = recipeText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                const recipeData = JSON.parse(recipeText);

                showPhotoImportStatus('âœ“ ' + (currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã‚’è§£æã—ã¾ã—ãŸï¼' : 'Recipe analyzed!'), 'success');
                showPhotoImportPreview(recipeData);

            } catch (error) {
                console.error('Error:', error);
                showPhotoImportStatus('âŒ ' + (currentLanguage === 'ja' ? 'å†™çœŸã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®å†™çœŸã‚’è©¦ã™ã‹ã€ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' : 'Failed to analyze photo. Try another photo or use text input.'), 'error');
            }
        }

        function showPhotoImportStatus(message, type) {
            const statusDiv = document.getElementById('photoImportStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            if (type === 'loading') {
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
                statusDiv.style.border = '2px solid #1976d2';
            } else if (type === 'success') {
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.style.border = '2px solid #2e7d32';
            } else if (type === 'error') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.style.border = '2px solid #c62828';
            }
        }

        function showPhotoImportPreview(recipeData) {
            const preview = document.getElementById('photoImportPreview');
            
            let html = `
                <div style="border: 2px solid #e67e22; border-radius: 10px; padding: 20px; background: #f8f9fa;">
                    <h3 style="color: #e67e22; margin-bottom: 15px;">ğŸ“‹ è§£æã—ãŸãƒ¬ã‚·ãƒ”</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${recipeData.title}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>åˆ†é‡:</strong> ${recipeData.yield} | 
                        <strong>æ™‚é–“:</strong> ${recipeData.cookingTime}åˆ†
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> ${recipeData.categories.join(', ')}
                    </div>
                    
                    ${recipeData.detectedInfo ? `
                        <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                            <strong>ğŸ’¡ æ¤œå‡ºæƒ…å ±:</strong> ${recipeData.detectedInfo}
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ææ–™ (${recipeData.ingredients.length}å€‹):</strong>
                        <ul style="margin: 5px 0 0 20px;">
                            ${recipeData.ingredients.slice(0, 5).map(ing => `<li>${convertUnits(ing)}</li>`).join('')}
                            ${recipeData.ingredients.length > 5 ? `<li><em>ä»– ${recipeData.ingredients.length - 5}å€‹...</em></li>` : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>æ‰‹é † (${recipeData.instructions.length}ã‚¹ãƒ†ãƒƒãƒ—):</strong>
                        <ol style="margin: 5px 0 0 20px;">
                            ${recipeData.instructions.slice(0, 3).map(step => `<li>${step}</li>`).join('')}
                            ${recipeData.instructions.length > 3 ? `<li><em>ä»– ${recipeData.instructions.length - 3}ã‚¹ãƒ†ãƒƒãƒ—...</em></li>` : ''}
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="savePhotoImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1; background: #e67e22; border: none;">
                            âœ“ ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
                        </button>
                        <button onclick="editPhotoImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1;">
                            âœ ç·¨é›†ã—ã¦ã‹ã‚‰ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            preview.innerHTML = html;
        }

        function savePhotoImportedRecipe(recipeData) {
            const convertedIngredients = recipeData.ingredients.map(ing => convertUnits(ing));
            
            const recipe = {
                id: Date.now(),
                title: recipeData.title,
                yield: recipeData.yield,
                baseServings: extractServingsNumber(recipeData.yield),
                cookingTime: recipeData.cookingTime,
                caloriesPerServing: recipeData.caloriesPerServing || null,
                categories: recipeData.categories,
                seasons: ['é€šå¹´'],
                events: ['æ™®æ®µ'],
                ingredients: convertedIngredients,
                instructions: recipeData.instructions,
                imageUrl: '',
                sourceUrl: '',
                notes: recipeData.detectedInfo || '',
                createdAt: Date.now()
            };

            recipes.push(recipe);
            saveRecipes();
            closePhotoImportModal();
            renderRecipes();
            
            alert('âœ“ ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function editPhotoImportedRecipe(recipeData) {
            closePhotoImportModal();
            
            editingId = null;
            document.getElementById('modalTitle').textContent = 'å†™çœŸå–è¾¼ãƒ¬ã‚·ãƒ”ã®ç·¨é›†';
            document.getElementById('recipeTitle').value = recipeData.title;
            document.getElementById('recipeYield').value = recipeData.yield;
            document.getElementById('cookingTime').value = recipeData.cookingTime;
            document.getElementById('caloriesPerServing').value = recipeData.caloriesPerServing || '';
            document.getElementById('instructions').value = recipeData.instructions.join('\n');
            document.getElementById('imageUrl').value = '';

            document.querySelectorAll('input[name="category"]').forEach(cb => {
                cb.checked = recipeData.categories.includes(cb.value);
            });
            
            document.querySelectorAll('input[name="season"]').forEach(cb => {
                cb.checked = cb.value === 'é€šå¹´';
            });
            document.querySelectorAll('input[name="event"]').forEach(cb => {
                cb.checked = cb.value === 'æ™®æ®µ';
            });

            document.getElementById('ingredientsList').innerHTML = '';
            recipeData.ingredients.forEach(ing => addIngredientField(ing));
            addIngredientField();

            document.getElementById('recipeModal').style.display = 'block';
        }

        async function parseRecipeFromText() {
            const text = document.getElementById('importText').value.trim();
            if (!text) {
                showTextImportStatus(currentLanguage === 'ja' ? 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' : 'Please enter text', 'error');
                return;
            }

            showTextImportStatus(currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã‚’è§£æä¸­...' : 'Analyzing recipe...', 'loading');

            try {
                const response = await fetch(`https://api.anthropic.com/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: `Extract recipe information from the following text. Format may be inconsistent but extract as much information as possible.

Text:
${text}

Return ONLY valid JSON (no markdown, no explanations, no code blocks):
{
  "title": "recipe title",
  "yield": "appropriate format: bread/cakes='X loaves', cookies='X pieces', meals='X servings'",
  "cookingTime": time in minutes (number),
  "caloriesPerServing": calories per serving (number or null),
  "ingredients": ["ingredient 1 with amount", "ingredient 2 with amount", ...],
  "instructions": ["step 1", "step 2", ...],
  "categories": ["å’Œé£Ÿ" or "æ´‹é£Ÿ" or "ä¸­è¯" or "ãƒ‡ã‚¶ãƒ¼ãƒˆ" or "ãã®ä»–"],
  "detectedInfo": "any other detected info"
}

CRITICAL: Return ONLY the JSON object. No text before or after. No markdown code blocks.`
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    throw new Error('API_ERROR: ' + response.status);
                }

                const data = await response.json();
                let recipeText = data.content[0].text;
                
                console.log('Raw API Response:', recipeText);
                
                // Remove markdown code blocks if present
                recipeText = recipeText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                console.log('Cleaned Response:', recipeText);
                
                let recipeData;
                try {
                    recipeData = JSON.parse(recipeText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Failed to parse:', recipeText);
                    showTextParseError(text, recipeText);
                    return;
                }

                showTextImportStatus('âœ“ ' + (currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã‚’è§£æã—ã¾ã—ãŸï¼' : 'Recipe analyzed!'), 'success');
                showTextImportPreview(recipeData);

            } catch (error) {
                console.error('Error:', error);
                showTextImportStatus('âŒ ' + (currentLanguage === 'ja' ? `ã‚¨ãƒ©ãƒ¼: ${error.message}` : `Error: ${error.message}`), 'error');
                showManualInputOption();
            }
        }

        function showTextParseError(originalText, apiResponse) {
            const preview = document.getElementById('textImportPreview');
            const message = `
                <div style="border: 2px solid #e67e22; border-radius: 10px; padding: 20px; background: #fff9f0;">
                    <h3 style="color: #e67e22; margin-bottom: 15px;">âš ï¸ ${currentLanguage === 'ja' ? 'è§£æã‚¨ãƒ©ãƒ¼' : 'Parse Error'}</h3>
                    <p>${currentLanguage === 'ja' ? 'APIã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' : 'API response was not valid JSON format.'}</p>
                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; color: #666;">${currentLanguage === 'ja' ? 'ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º' : 'Show debug info'}</summary>
                        <div style="background: #f5f5f5; padding: 10px; margin-top: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; word-break: break-all;">
                            ${apiResponse.substring(0, 1000)}
                        </div>
                    </details>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="parseRecipeFromText()" class="btn-primary" style="flex: 1; background: #e67e22;">
                            ğŸ”„ ${currentLanguage === 'ja' ? 'å†è©¦è¡Œ' : 'Retry'}
                        </button>
                        <button onclick="closeTextImportModal(); openAddModal();" class="btn-primary" style="flex: 1;">
                            âœï¸ ${currentLanguage === 'ja' ? 'æ‰‹å‹•å…¥åŠ›' : 'Manual Input'}
                        </button>
                    </div>
                </div>
            `;
            preview.innerHTML = message;
        }

        function showManualInputOption() {
            const preview = document.getElementById('textImportPreview');
            if (!preview.innerHTML) {
                preview.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="closeTextImportModal(); openAddModal();" class="btn-primary">
                            âœï¸ ${currentLanguage === 'ja' ? 'æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹' : 'Manual Input'}
                        </button>
                    </div>
                `;
            }
        }

        function showTextImportStatus(message, type) {
            const statusDiv = document.getElementById('textImportStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            if (type === 'loading') {
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
                statusDiv.style.border = '2px solid #1976d2';
            } else if (type === 'success') {
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.style.border = '2px solid #2e7d32';
            } else if (type === 'error') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.style.border = '2px solid #c62828';
            }
        }

        function showTextImportPreview(recipeData) {
            const preview = document.getElementById('textImportPreview');
            
            let html = `
                <div style="border: 2px solid #9b59b6; border-radius: 10px; padding: 20px; background: #f8f9fa;">
                    <h3 style="color: #9b59b6; margin-bottom: 15px;">ğŸ“‹ è§£æã—ãŸãƒ¬ã‚·ãƒ”</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${recipeData.title}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>åˆ†é‡:</strong> ${recipeData.yield} | 
                        <strong>æ™‚é–“:</strong> ${recipeData.cookingTime}åˆ†
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> ${recipeData.categories.join(', ')}
                    </div>
                    
                    ${recipeData.detectedInfo ? `
                        <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                            <strong>ğŸ’¡ æ¤œå‡ºæƒ…å ±:</strong> ${recipeData.detectedInfo}
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ææ–™ (${recipeData.ingredients.length}å€‹):</strong>
                        <ul style="margin: 5px 0 0 20px;">
                            ${recipeData.ingredients.slice(0, 5).map(ing => `<li>${convertUnits(ing)}</li>`).join('')}
                            ${recipeData.ingredients.length > 5 ? `<li><em>ä»– ${recipeData.ingredients.length - 5}å€‹...</em></li>` : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>æ‰‹é † (${recipeData.instructions.length}ã‚¹ãƒ†ãƒƒãƒ—):</strong>
                        <ol style="margin: 5px 0 0 20px;">
                            ${recipeData.instructions.slice(0, 3).map(step => `<li>${step}</li>`).join('')}
                            ${recipeData.instructions.length > 3 ? `<li><em>ä»– ${recipeData.instructions.length - 3}ã‚¹ãƒ†ãƒƒãƒ—...</em></li>` : ''}
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveTextImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1; background: #9b59b6; border: none;">
                            âœ“ ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
                        </button>
                        <button onclick="editTextImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1;">
                            âœ ç·¨é›†ã—ã¦ã‹ã‚‰ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            preview.innerHTML = html;
        }

        function saveTextImportedRecipe(recipeData) {
            // Convert ingredients to more common units
            const convertedIngredients = recipeData.ingredients.map(ing => convertUnits(ing));
            
            const recipe = {
                id: Date.now(),
                title: recipeData.title,
                yield: recipeData.yield,
                baseServings: extractServingsNumber(recipeData.yield),
                cookingTime: recipeData.cookingTime,
                caloriesPerServing: recipeData.caloriesPerServing || null,
                categories: recipeData.categories,
                seasons: ['é€šå¹´'],
                events: ['æ™®æ®µ'],
                ingredients: convertedIngredients,
                instructions: recipeData.instructions,
                imageUrl: '',
                sourceUrl: '',
                notes: recipeData.detectedInfo || '',
                createdAt: Date.now()
            };

            recipes.push(recipe);
            saveRecipes();
            closeTextImportModal();
            renderRecipes();
            
            alert('âœ“ ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function editTextImportedRecipe(recipeData) {
            closeTextImportModal();
            
            // Open edit modal with pre-filled data
            editingId = null;
            document.getElementById('modalTitle').textContent = 'ãƒ†ã‚­ã‚¹ãƒˆå–è¾¼ãƒ¬ã‚·ãƒ”ã®ç·¨é›†';
            document.getElementById('recipeTitle').value = recipeData.title;
            document.getElementById('recipeYield').value = recipeData.yield;
            document.getElementById('cookingTime').value = recipeData.cookingTime;
            document.getElementById('instructions').value = recipeData.instructions.join('\n');
            document.getElementById('imageUrl').value = '';

            // Set categories
            document.querySelectorAll('input[name="category"]').forEach(cb => {
                cb.checked = recipeData.categories.includes(cb.value);
            });
            
            // Set default season and event
            document.querySelectorAll('input[name="season"]').forEach(cb => {
                cb.checked = cb.value === 'é€šå¹´';
            });
            document.querySelectorAll('input[name="event"]').forEach(cb => {
                cb.checked = cb.value === 'æ™®æ®µ';
            });

            // Set ingredients
            document.getElementById('ingredientsList').innerHTML = '';
            recipeData.ingredients.forEach(ing => addIngredientField(ing));
            addIngredientField();

            document.getElementById('recipeModal').style.display = 'block';
        }

        async function fetchRecipeFromUrl() {
            const url = document.getElementById('importUrl').value.trim();
            if (!url) {
                showImportStatus(currentLanguage === 'ja' ? 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' : 'Please enter a URL', 'error');
                return;
            }

            showImportStatus(currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã‚’å–å¾—ä¸­...' : 'Fetching recipe...', 'loading');

            try {
                const response = await fetch(`https://api.anthropic.com/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: `I need you to help extract recipe information. If you cannot access the URL directly, please tell me that in your response.

URL: ${url}

If you CAN access this URL, extract the recipe and return ONLY valid JSON (no markdown, no explanations):
{
  "title": "recipe title",
  "yield": "serving size or quantity",
  "cookingTime": minutes,
  "caloriesPerServing": number or null,
  "ingredients": ["ingredient with amount", ...],
  "instructions": ["step 1", ...],
  "imageUrl": "image URL or empty string",
  "sourceUrl": "${url}",
  "categories": ["å’Œé£Ÿ" or "æ´‹é£Ÿ" or "ä¸­è¯" or "ãƒ‡ã‚¶ãƒ¼ãƒˆ" or "ãã®ä»–"],
  "language": "ja" or "en"
}

If you CANNOT access the URL, return this JSON:
{
  "error": "cannot_access",
  "message": "I cannot directly access web pages"
}

IMPORTANT: Return ONLY valid JSON, no other text.`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                let recipeText = data.content[0].text;
                
                // Remove markdown code blocks if present
                recipeText = recipeText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                // Try to parse as JSON
                let recipeData;
                try {
                    recipeData = JSON.parse(recipeText);
                } catch (parseError) {
                    // If parsing fails, it means Claude couldn't access the URL
                    throw new Error('url_access_failed');
                }

                // Check if there's an error in the response
                if (recipeData.error === 'cannot_access') {
                    throw new Error('url_access_failed');
                }

                showImportStatus('âœ“ ' + (currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã‚’å–å¾—ã—ã¾ã—ãŸï¼' : 'Recipe fetched!'), 'success');
                showImportPreview(recipeData);

            } catch (error) {
                console.error('Error:', error);
                
                if (error.message === 'url_access_failed') {
                    showUrlAccessError(url);
                } else {
                    showImportStatus('âŒ ' + (currentLanguage === 'ja' ? 'ãƒ¬ã‚·ãƒ”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'Failed to fetch recipe'), 'error');
                    showUrlAccessError(url);
                }
            }
        }

        function showUrlAccessError(url) {
            const preview = document.getElementById('importPreview');
            
            const message = currentLanguage === 'ja' ? `
                <div style="border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; background: #fff5f5;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">âš ï¸ URLã‹ã‚‰ç›´æ¥å–å¾—ã§ãã¾ã›ã‚“</h3>
                    
                    <p style="margin-bottom: 15px;">
                        æŠ€è¡“çš„ãªåˆ¶é™ã«ã‚ˆã‚Šã€ä¸€éƒ¨ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‹ã‚‰ã¯ç›´æ¥ãƒ¬ã‚·ãƒ”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚
                    </p>
                    
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">âœ… ä»£ã‚ã‚Šã®æ–¹æ³•ï¼ˆç°¡å˜ãƒ»ç¢ºå®Ÿï¼‰</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>ãƒ¬ã‚·ãƒ”ãƒšãƒ¼ã‚¸ã‚’é–‹ã</strong><br>
                                <a href="${url}" target="_blank" style="color: #1976d2; word-break: break-all;">${url}</a>
                            </li>
                            <li><strong>ãƒ¬ã‚·ãƒ”éƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒ¼</strong><br>
                                ã‚¿ã‚¤ãƒˆãƒ«ã€ææ–™ã€ä½œã‚Šæ–¹ã‚’ã™ã¹ã¦é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ï¼ˆCtrl+Cï¼‰
                            </li>
                            <li><strong>ã€ŒğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–è¾¼ã€ã‚’ä½¿ã†</strong><br>
                                ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¦ã€ã€ŒğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–è¾¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                            </li>
                            <li><strong>ã‚³ãƒ”ãƒ¼ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</strong><br>
                                ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è²¼ã‚Šä»˜ã‘ã¦ã€Œè§£æã—ã¦å–ã‚Šè¾¼ã‚€ã€
                            </li>
                        </ol>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
                        <p style="margin: 0;">
                            ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–ã‚Šè¾¼ã‚€æ–¹ãŒç¢ºå®Ÿã§ã€ã©ã‚“ãªã‚µã‚¤ãƒˆã§ã‚‚ä½¿ãˆã¾ã™ï¼<br>
                            ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒãƒãƒ©ãƒãƒ©ã§ã‚‚AIãŒè‡ªå‹•ã§æ•´ç†ã—ã¾ã™ã€‚
                        </p>
                    </div>
                    
                    <button onclick="closeImportModal(); openTextImportModal();" class="btn-primary" style="width: 100%; margin-top: 15px; background: #9b59b6;">
                        ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–è¾¼ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                    </button>
                </div>
            ` : `
                <div style="border: 2px solid #e74c3c; border-radius: 10px; padding: 20px; background: #fff5f5;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">âš ï¸ Cannot Access URL Directly</h3>
                    
                    <p style="margin-bottom: 15px;">
                        Due to technical limitations, we cannot directly fetch recipes from some websites.
                    </p>
                    
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">âœ… Alternative Method (Easy & Reliable)</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li><strong>Open the recipe page</strong><br>
                                <a href="${url}" target="_blank" style="color: #1976d2; word-break: break-all;">${url}</a>
                            </li>
                            <li><strong>Copy the recipe</strong><br>
                                Select and copy the title, ingredients, and instructions (Ctrl+C)
                            </li>
                            <li><strong>Use "ğŸ“ Import from Text"</strong><br>
                                Close this window and click "ğŸ“ Import from Text" button
                            </li>
                            <li><strong>Paste the text</strong><br>
                                Paste into the text box and click "Parse and Import"
                            </li>
                        </ol>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ’¡ Tip</h4>
                        <p style="margin: 0;">
                            Text import is more reliable and works with ANY website!<br>
                            AI will automatically organize messy formats.
                        </p>
                    </div>
                    
                    <button onclick="closeImportModal(); openTextImportModal();" class="btn-primary" style="width: 100%; margin-top: 15px; background: #9b59b6;">
                        ğŸ“ Switch to Text Import
                    </button>
                </div>
            `;
            
            preview.innerHTML = message;
        }

        function showImportStatus(message, type) {
            const statusDiv = document.getElementById('importStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            if (type === 'loading') {
                statusDiv.style.background = '#e3f2fd';
                statusDiv.style.color = '#1976d2';
                statusDiv.style.border = '2px solid #1976d2';
            } else if (type === 'success') {
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.color = '#2e7d32';
                statusDiv.style.border = '2px solid #2e7d32';
            } else if (type === 'error') {
                statusDiv.style.background = '#ffebee';
                statusDiv.style.color = '#c62828';
                statusDiv.style.border = '2px solid #c62828';
            }
        }

        function showImportPreview(recipeData) {
            const preview = document.getElementById('importPreview');
            
            let html = `
                <div style="border: 2px solid #27ae60; border-radius: 10px; padding: 20px; background: #f8f9fa;">
                    <h3 style="color: #27ae60; margin-bottom: 15px;">ğŸ“‹ å–å¾—ã—ãŸãƒ¬ã‚·ãƒ”</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${recipeData.title}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>åˆ†é‡:</strong> ${recipeData.yield} | 
                        <strong>æ™‚é–“:</strong> ${recipeData.cookingTime}åˆ†
                    </div>
                    
                    ${recipeData.imageUrl ? `
                        <div style="margin-bottom: 15px;">
                            <img src="${recipeData.imageUrl}" style="max-width: 100%; max-height: 200px; border-radius: 8px;" onerror="this.style.display='none'">
                        </div>
                    ` : ''}
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> ${recipeData.categories.join(', ')}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ææ–™ (${recipeData.ingredients.length}å€‹):</strong>
                        <ul style="margin: 5px 0 0 20px;">
                            ${recipeData.ingredients.slice(0, 5).map(ing => `<li>${convertUnits(ing)}</li>`).join('')}
                            ${recipeData.ingredients.length > 5 ? `<li><em>ä»– ${recipeData.ingredients.length - 5}å€‹...</em></li>` : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>æ‰‹é † (${recipeData.instructions.length}ã‚¹ãƒ†ãƒƒãƒ—):</strong>
                        <ol style="margin: 5px 0 0 20px;">
                            ${recipeData.instructions.slice(0, 3).map(step => `<li>${step}</li>`).join('')}
                            ${recipeData.instructions.length > 3 ? `<li><em>ä»– ${recipeData.instructions.length - 3}ã‚¹ãƒ†ãƒƒãƒ—...</em></li>` : ''}
                        </ol>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="saveImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1; background: #27ae60; border: none;">
                            âœ“ ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
                        </button>
                        <button onclick="editImportedRecipe(${JSON.stringify(recipeData).replace(/"/g, '&quot;')})" 
                                class="btn-primary" style="flex: 1;">
                            âœ ç·¨é›†ã—ã¦ã‹ã‚‰ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            preview.innerHTML = html;
        }

        function saveImportedRecipe(recipeData) {
            // Convert ingredients to more common units
            const convertedIngredients = recipeData.ingredients.map(ing => convertUnits(ing));
            
            const recipe = {
                id: Date.now(),
                title: recipeData.title,
                yield: recipeData.yield,
                baseServings: extractServingsNumber(recipeData.yield),
                cookingTime: recipeData.cookingTime,
                caloriesPerServing: recipeData.caloriesPerServing || null,
                categories: recipeData.categories,
                seasons: ['é€šå¹´'],
                events: ['æ™®æ®µ'],
                ingredients: convertedIngredients,
                instructions: recipeData.instructions,
                imageUrl: recipeData.imageUrl,
                sourceUrl: recipeData.sourceUrl,
                notes: '',
                createdAt: Date.now()
            };

            recipes.push(recipe);
            saveRecipes();
            closeImportModal();
            renderRecipes();
            
            alert('âœ“ ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function editImportedRecipe(recipeData) {
            closeImportModal();
            
            // Open edit modal with pre-filled data
            editingId = null;
            document.getElementById('modalTitle').textContent = 'å–è¾¼ãƒ¬ã‚·ãƒ”ã®ç·¨é›†';
            document.getElementById('recipeTitle').value = recipeData.title;
            document.getElementById('recipeYield').value = recipeData.yield;
            document.getElementById('cookingTime').value = recipeData.cookingTime;
            document.getElementById('instructions').value = recipeData.instructions.join('\n');
            document.getElementById('imageUrl').value = recipeData.imageUrl || '';

            // Set categories
            document.querySelectorAll('input[name="category"]').forEach(cb => {
                cb.checked = recipeData.categories.includes(cb.value);
            });
            
            // Set default season and event
            document.querySelectorAll('input[name="season"]').forEach(cb => {
                cb.checked = cb.value === 'é€šå¹´';
            });
            document.querySelectorAll('input[name="event"]').forEach(cb => {
                cb.checked = cb.value === 'æ™®æ®µ';
            });

            // Set ingredients
            document.getElementById('ingredientsList').innerHTML = '';
            recipeData.ingredients.forEach(ing => addIngredientField(ing));
            addIngredientField();

            document.getElementById('recipeModal').style.display = 'block';
        }

        function addIngredientField(value = '') {
            const list = document.getElementById('ingredientsList');
            const div = document.createElement('div');
            div.className = 'ingredient-item';
            div.innerHTML = `
                <input type="text" placeholder="ä¾‹: 2 cups flour" value="${value}">
                <button type="button" onclick="this.parentElement.remove()">Ã—</button>
            `;
            list.appendChild(div);
        }

        function getCheckedValues(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(cb => cb.value);
        }

        document.getElementById('recipeForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const ingredients = Array.from(document.querySelectorAll('#ingredientsList input'))
                .map(input => input.value.trim())
                .filter(val => val !== '');

            const yieldValue = document.getElementById('recipeYield').value.trim();
            const caloriesValue = document.getElementById('caloriesPerServing').value;

            const recipe = {
                id: editingId || Date.now(),
                title: document.getElementById('recipeTitle').value,
                yield: yieldValue,
                baseServings: extractServingsNumber(yieldValue),
                cookingTime: parseInt(document.getElementById('cookingTime').value),
                caloriesPerServing: caloriesValue ? parseInt(caloriesValue) : null,
                categories: getCheckedValues('category'),
                seasons: getCheckedValues('season'),
                events: getCheckedValues('event'),
                ingredients: ingredients,
                instructions: document.getElementById('instructions').value.split('\n').filter(s => s.trim()),
                imageUrl: document.getElementById('imageUrl').value,
                notes: '',
                createdAt: editingId ? recipes.find(r => r.id === editingId).createdAt : Date.now()
            };

            if (editingId) {
                const index = recipes.findIndex(r => r.id === editingId);
                recipes[index] = { ...recipes[index], ...recipe };
            } else {
                recipes.push(recipe);
            }

            saveRecipes();
            closeModal();
            renderRecipes();
        });

        function extractServingsNumber(yieldText) {
            // Extract number from yield text for scaling calculations
            const match = yieldText.match(/(\d+)/);
            return match ? parseInt(match[1]) : 4;
        }

        function editRecipe(id) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'ãƒ¬ã‚·ãƒ”ç·¨é›†';
            document.getElementById('recipeTitle').value = recipe.title;
            document.getElementById('recipeYield').value = recipe.yield || `${recipe.baseServings}äººåˆ†`;
            document.getElementById('cookingTime').value = recipe.cookingTime;
            document.getElementById('caloriesPerServing').value = recipe.caloriesPerServing || '';
            document.getElementById('instructions').value = recipe.instructions.join('\n');
            document.getElementById('imageUrl').value = recipe.imageUrl || '';

            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€å­£ç¯€ã€ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.querySelectorAll('input[name="category"]').forEach(cb => {
                cb.checked = recipe.categories.includes(cb.value);
            });
            document.querySelectorAll('input[name="season"]').forEach(cb => {
                cb.checked = recipe.seasons.includes(cb.value);
            });
            document.querySelectorAll('input[name="event"]').forEach(cb => {
                cb.checked = recipe.events.includes(cb.value);
            });

            // ææ–™
            document.getElementById('ingredientsList').innerHTML = '';
            recipe.ingredients.forEach(ing => addIngredientField(ing));
            addIngredientField();

            document.getElementById('recipeModal').style.display = 'block';
        }

        function deleteRecipe(id) {
            const message = currentLanguage === 'ja' ? 'ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¾ã™ã‹?' : 'Delete this recipe?';
            if (confirm(message)) {
                recipes = recipes.filter(r => r.id !== id);
                saveRecipes();
                renderRecipes();
            }
        }

        function viewRecipe(id, servings) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            const ratio = servings / recipe.baseServings;
            const yieldText = recipe.yield || `${recipe.baseServings}${currentLanguage === 'ja' ? 'äººåˆ†' : ' servings'}`;
            
            // Calculate adjusted yield text
            let adjustedYield = yieldText;
            if (ratio !== 1) {
                const match = yieldText.match(/(\d+)(.+)/);
                if (match) {
                    const newAmount = Math.round(parseInt(match[1]) * ratio);
                    adjustedYield = `${newAmount}${match[2]}`;
                }
            }

            // Translate recipe content if needed
            translateRecipeContent(recipe, adjustedYield, ratio);
        }

        async function translateRecipeContent(recipe, adjustedYield, ratio) {
            const needsTranslation = shouldTranslateRecipe(recipe);
            
            if (needsTranslation) {
                showLoadingInModal((currentLanguage === 'ja' ? 'ç¿»è¨³ä¸­...' : 'Translating...'));
                
                try {
                    const translatedRecipe = await translateRecipe(recipe);
                    displayRecipeContent(translatedRecipe, adjustedYield, ratio);
                } catch (error) {
                    console.error('Translation error:', error);
                    // If translation fails, show original
                    displayRecipeContent(recipe, adjustedYield, ratio);
                }
            } else {
                displayRecipeContent(recipe, adjustedYield, ratio);
            }
        }

        function shouldTranslateRecipe(recipe) {
            // Check if recipe language differs from current UI language
            const recipeLanguage = detectRecipeLanguage(recipe);
            return recipeLanguage !== currentLanguage;
        }

        function detectRecipeLanguage(recipe) {
            // Simple detection based on character patterns
            const textSample = recipe.title + ' ' + (recipe.ingredients[0] || '') + ' ' + (recipe.instructions[0] || '');
            const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(textSample);
            return hasJapanese ? 'ja' : 'en';
        }

        async function translateRecipe(recipe) {
            const targetLanguage = currentLanguage;
            const prompt = targetLanguage === 'ja' 
                ? `Translate the following recipe to Japanese. Keep measurements in original units. Return ONLY valid JSON with no markdown formatting:

{
  "title": "translated title",
  "ingredients": ["translated ingredient 1", "translated ingredient 2", ...],
  "instructions": ["translated step 1", "translated step 2", ...],
  "notes": "translated notes (or empty string if no notes)"
}

Recipe:
Title: ${recipe.title}
Ingredients: ${recipe.ingredients.join(', ')}
Instructions: ${recipe.instructions.join(' ')}
Notes: ${recipe.notes || 'No notes'}`
                : `Translate the following recipe to English. Keep measurements in original units. Return ONLY valid JSON with no markdown formatting:

{
  "title": "translated title",
  "ingredients": ["translated ingredient 1", "translated ingredient 2", ...],
  "instructions": ["translated step 1", "translated step 2", ...],
  "notes": "translated notes (or empty string if no notes)"
}

Recipe:
Title: ${recipe.title}
Ingredients: ${recipe.ingredients.join(', ')}
Instructions: ${recipe.instructions.join(' ')}
Notes: ${recipe.notes || 'No notes'}`;

            const response = await fetch(`https://api.anthropic.com/v1/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 3000,
                    messages: [{ role: 'user', content: prompt }]
                })
            });

            if (!response.ok) {
                throw new Error('Translation failed');
            }

            const data = await response.json();
            let translatedText = data.content[0].text;
            translatedText = translatedText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            const translated = JSON.parse(translatedText);

            return {
                ...recipe,
                title: translated.title,
                ingredients: translated.ingredients,
                instructions: translated.instructions,
                notes: translated.notes || recipe.notes,
                originalNotes: recipe.notes // Keep original for editing
            };
        }

        function showLoadingInModal(message) {
            document.getElementById('detailTitle').textContent = message;
            document.getElementById('detailContent').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #7f8c8d;">
                    <div style="font-size: 40px; margin-bottom: 20px;">â³</div>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }

        function displayRecipeContent(recipe, adjustedYield, ratio) {
            const yieldText = recipe.yield || `${recipe.baseServings}${currentLanguage === 'ja' ? 'äººåˆ†' : ' servings'}`;
            const translatedYield = translateYield(yieldText);
            const translatedAdjustedYield = translateYield(adjustedYield);

            let html = `
                <div class="recipe-meta">
                    <span>ğŸ“Š ${translatedAdjustedYield}${ratio !== 1 ? ` (${currentLanguage === 'ja' ? 'åŸºæº–' : 'Base'}: ${translatedYield})` : ''}</span>
                    <span>â±ï¸ ${recipe.cookingTime}${t('minutes')}</span>
                    ${recipe.caloriesPerServing ? `<span>ğŸ”¥ ${recipe.caloriesPerServing}${currentLanguage === 'ja' ? 'kcal/äºº' : 'kcal/serving'}</span>` : ''}
                </div>
                <div class="category-tags">
                    ${[...recipe.categories, ...recipe.seasons, ...recipe.events].map(tag => 
                        `<span class="tag">${translateTag(tag)}</span>`
                    ).join('')}
                </div>
            `;

            if (recipe.imageUrl) {
                html += `<img src="${recipe.imageUrl}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin: 15px 0;" onerror="this.style.display='none'">`;
            }

            html += `
                <h4>${t('ingredients')}ï¼ˆ${translatedAdjustedYield}ï¼‰</h4>
                <div class="ingredients-list">
                    <ul>
                        ${recipe.ingredients.map(ing => {
                            let adjusted = adjustIngredient(ing, ratio);
                            adjusted = convertUnits(adjusted);
                            return `<li>${adjusted}</li>`;
                        }).join('')}
                    </ul>
                </div>

                <h4>${t('instructions')}</h4>
                <ol class="steps-list">
                    ${recipe.instructions.map(step => `<li>${step}</li>`).join('')}
                </ol>

                ${recipe.sourceUrl ? `
                    <div style="margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <strong>ğŸ”— ${t('sourceRecipe')}:</strong> 
                        <a href="${recipe.sourceUrl}" target="_blank" style="color: #1976d2; text-decoration: none; word-break: break-all;">
                            ${recipe.sourceUrl}
                        </a>
                    </div>
                ` : ''}

                <div class="notes-section">
                    <h4 style="margin-top: 0;">ğŸ“ ${t('notes')}</h4>
                    ${recipe.notes ? `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; white-space: pre-wrap; line-height: 1.6;">
                            ${recipe.notes}
                        </div>
                    ` : ''}
                    <textarea id="recipeNotes" placeholder="${currentLanguage === 'ja' ? 'æ”¹å–„ç‚¹ã‚„å¤‰æ›´å†…å®¹ã‚’è¨˜å…¥...' : 'Write improvements or changes...'}">${recipe.originalNotes || ''}</textarea>
                    <button onclick="saveNotes(${recipe.id})" class="btn-primary" style="margin-top: 10px;">${t('saveNotes')}</button>
                </div>
            `;

            document.getElementById('detailTitle').textContent = recipe.title;
            document.getElementById('detailContent').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';
        }

        function saveNotes(id) {
            const recipe = recipes.find(r => r.id === id);
            if (recipe) {
                recipe.notes = document.getElementById('recipeNotes').value;
                saveRecipes();
                alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            }
        }

        function adjustIngredient(ingredient, ratio) {
            const match = ingredient.match(/^([\d./\s]+)\s*(.+)$/);
            if (!match) return ingredient;

            const [, amount, rest] = match;
            try {
                const num = eval(amount.replace(/\s+/g, ''));
                const adjusted = (num * ratio).toFixed(2).replace(/\.?0+$/, '');
                return `${adjusted} ${rest}`;
            } catch {
                return ingredient;
            }
        }

        function convertUnits(text) {
            // Convert oz (ounces) to grams or tablespoons
            text = text.replace(/(\d+(?:\.\d+)?)\s*oz\b/gi, (match, num) => {
                const ounces = parseFloat(num);
                const grams = Math.round(ounces * 28.35);
                return `${grams}g (${num} oz)`;
            });

            // Convert fluid oz to ml or cups
            text = text.replace(/(\d+(?:\.\d+)?)\s*fl\.?\s*oz\b/gi, (match, num) => {
                const floz = parseFloat(num);
                if (floz === 8) return '1 cup (8 fl oz)';
                if (floz === 4) return '1/2 cup (4 fl oz)';
                if (floz === 2) return '1/4 cup (2 fl oz)';
                const ml = Math.round(floz * 29.57);
                return `${ml}ml (${num} fl oz)`;
            });

            // Convert pounds to grams/kg
            text = text.replace(/(\d+(?:\.\d+)?)\s*(?:lb|lbs|pound|pounds)\b/gi, (match, num) => {
                const pounds = parseFloat(num);
                const grams = Math.round(pounds * 453.59);
                if (grams >= 1000) {
                    const kg = (grams / 1000).toFixed(2).replace(/\.?0+$/, '');
                    return `${kg}kg (${num} lb)`;
                }
                return `${grams}g (${num} lb)`;
            });

            // Convert quarts to liters or cups
            text = text.replace(/(\d+(?:\.\d+)?)\s*(?:qt|qts|quart|quarts)\b/gi, (match, num) => {
                const quarts = parseFloat(num);
                const liters = (quarts * 0.946).toFixed(2).replace(/\.?0+$/, '');
                return `${liters}L (${num} qt)`;
            });

            // Convert pints to ml or cups
            text = text.replace(/(\d+(?:\.\d+)?)\s*(?:pt|pts|pint|pints)\b/gi, (match, num) => {
                const pints = parseFloat(num);
                const cups = pints * 2;
                return `${cups} cups (${num} pt)`;
            });

            // Convert gallons to liters
            text = text.replace(/(\d+(?:\.\d+)?)\s*(?:gal|gallon|gallons)\b/gi, (match, num) => {
                const gallons = parseFloat(num);
                const liters = (gallons * 3.785).toFixed(2).replace(/\.?0+$/, '');
                return `${liters}L (${num} gal)`;
            });

            // Normalize common abbreviations
            text = text.replace(/\btbsp\b/gi, 'Tbsp');
            text = text.replace(/\btsp\b/gi, 'tsp');
            text = text.replace(/\bc\b(?!\w)/gi, 'cup');

            return text;
        }

        function renderRecipes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const seasonFilter = document.getElementById('seasonFilter').value;
            const eventFilter = document.getElementById('eventFilter').value;

            let filtered = recipes.filter(recipe => {
                const matchesSearch = recipe.title.toLowerCase().includes(searchTerm) ||
                    recipe.ingredients.some(i => i.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || recipe.categories.includes(categoryFilter);
                const matchesSeason = !seasonFilter || recipe.seasons.includes(seasonFilter);
                const matchesEvent = !eventFilter || recipe.events.includes(eventFilter);

                return matchesSearch && matchesCategory && matchesSeason && matchesEvent;
            });

            const grid = document.getElementById('recipeGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 60px;">ğŸ½ï¸</div>
                        <p>${t('emptyState')}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(recipe => {
                const currentServings = recipe.currentServings || recipe.baseServings;
                const yieldText = recipe.yield || `${recipe.baseServings}${currentLanguage === 'ja' ? 'äººåˆ†' : ' servings'}`;
                
                // Calculate adjusted yield
                const ratio = currentServings / recipe.baseServings;
                let displayYield = translateYield(yieldText);
                if (ratio !== 1) {
                    const match = displayYield.match(/(\d+)(.+)/);
                    if (match) {
                        const newAmount = Math.round(parseInt(match[1]) * ratio);
                        displayYield = `${newAmount}${match[2]}`;
                    }
                }

                // Get translated title (from cache or original)
                const cacheKey = `${recipe.id}_${currentLanguage}`;
                const displayTitle = titleTranslationCache[cacheKey] || recipe.title;

                // Trigger background translation if not cached
                if (!titleTranslationCache[cacheKey]) {
                    getTranslatedTitle(recipe.id, recipe.title);
                }
                
                return `
                    <div class="recipe-card" data-recipe-id="${recipe.id}">
                        <h3>${displayTitle}</h3>
                        <div class="recipe-meta">
                            <span>â±ï¸ ${recipe.cookingTime}${t('minutes')}</span>
                        </div>
                        <div class="category-tags">
                            ${[...recipe.categories, ...recipe.seasons, ...recipe.events].map(tag => 
                                `<span class="tag">${translateTag(tag)}</span>`
                            ).join('')}
                        </div>
                        <div class="serving-adjuster">
                            <button onclick="adjustServings(${recipe.id}, -1)">âˆ’</button>
                            <span style="flex: 1; text-align: center; font-weight: bold;">ğŸ“Š ${displayYield}</span>
                            <button onclick="adjustServings(${recipe.id}, 1)">+</button>
                        </div>
                        <div class="card-buttons">
                            <button onclick="viewRecipe(${recipe.id}, ${currentServings})">${t('detail')}</button>
                            <button onclick="editRecipe(${recipe.id})">${t('edit')}</button>
                            <button onclick="deleteRecipe(${recipe.id})" style="background: #e74c3c; color: white; border: none;">${t('delete')}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function translateTag(tag) {
            const tagTranslations = {
                // Categories
                'å’Œé£Ÿ': currentLanguage === 'en' ? 'Japanese' : 'å’Œé£Ÿ',
                'æ´‹é£Ÿ': currentLanguage === 'en' ? 'Western' : 'æ´‹é£Ÿ',
                'ä¸­è¯': currentLanguage === 'en' ? 'Chinese' : 'ä¸­è¯',
                'ãƒ‡ã‚¶ãƒ¼ãƒˆ': currentLanguage === 'en' ? 'Dessert' : 'ãƒ‡ã‚¶ãƒ¼ãƒˆ',
                'ãã®ä»–': currentLanguage === 'en' ? 'Other' : 'ãã®ä»–',
                // Seasons
                'æ˜¥': currentLanguage === 'en' ? 'Spring' : 'æ˜¥',
                'å¤': currentLanguage === 'en' ? 'Summer' : 'å¤',
                'ç§‹': currentLanguage === 'en' ? 'Fall' : 'ç§‹',
                'å†¬': currentLanguage === 'en' ? 'Winter' : 'å†¬',
                'é€šå¹´': currentLanguage === 'en' ? 'Year-round' : 'é€šå¹´',
                // Events
                'ãŠæ­£æœˆ': currentLanguage === 'en' ? 'New Year' : 'ãŠæ­£æœˆ',
                'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³': currentLanguage === 'en' ? 'Valentine' : 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³',
                'ã²ãªç¥­ã‚Š': currentLanguage === 'en' ? 'Hinamatsuri' : 'ã²ãªç¥­ã‚Š',
                'ãƒãƒ­ã‚¦ã‚£ãƒ³': currentLanguage === 'en' ? 'Halloween' : 'ãƒãƒ­ã‚¦ã‚£ãƒ³',
                'ã‚¯ãƒªã‚¹ãƒã‚¹': currentLanguage === 'en' ? 'Christmas' : 'ã‚¯ãƒªã‚¹ãƒã‚¹',
                'èª•ç”Ÿæ—¥': currentLanguage === 'en' ? 'Birthday' : 'èª•ç”Ÿæ—¥',
                'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼': currentLanguage === 'en' ? 'Party' : 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼',
                'æ™®æ®µ': currentLanguage === 'en' ? 'Everyday' : 'æ™®æ®µ',
                // English to Japanese
                'Japanese': currentLanguage === 'ja' ? 'å’Œé£Ÿ' : 'Japanese',
                'Western': currentLanguage === 'ja' ? 'æ´‹é£Ÿ' : 'Western',
                'Chinese': currentLanguage === 'ja' ? 'ä¸­è¯' : 'Chinese',
                'Dessert': currentLanguage === 'ja' ? 'ãƒ‡ã‚¶ãƒ¼ãƒˆ' : 'Dessert',
                'Other': currentLanguage === 'ja' ? 'ãã®ä»–' : 'Other',
                'Spring': currentLanguage === 'ja' ? 'æ˜¥' : 'Spring',
                'Summer': currentLanguage === 'ja' ? 'å¤' : 'Summer',
                'Fall': currentLanguage === 'ja' ? 'ç§‹' : 'Fall',
                'Winter': currentLanguage === 'ja' ? 'å†¬' : 'Winter',
                'Year-round': currentLanguage === 'ja' ? 'é€šå¹´' : 'Year-round',
                'New Year': currentLanguage === 'ja' ? 'ãŠæ­£æœˆ' : 'New Year',
                'Valentine': currentLanguage === 'ja' ? 'ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³' : 'Valentine',
                'Hinamatsuri': currentLanguage === 'ja' ? 'ã²ãªç¥­ã‚Š' : 'Hinamatsuri',
                'Halloween': currentLanguage === 'ja' ? 'ãƒãƒ­ã‚¦ã‚£ãƒ³' : 'Halloween',
                'Christmas': currentLanguage === 'ja' ? 'ã‚¯ãƒªã‚¹ãƒã‚¹' : 'Christmas',
                'Birthday': currentLanguage === 'ja' ? 'èª•ç”Ÿæ—¥' : 'Birthday',
                'Party': currentLanguage === 'ja' ? 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼' : 'Party',
                'Everyday': currentLanguage === 'ja' ? 'æ™®æ®µ' : 'Everyday'
            };
            return tagTranslations[tag] || tag;
        }

        function translateYield(yieldText) {
            if (currentLanguage === 'en') {
                // Japanese to English
                return yieldText
                    .replace(/(\d+)\s*äººåˆ†/g, '$1 servings')
                    .replace(/(\d+)\s*æœ¬/g, '$1 loaves')
                    .replace(/(\d+)\s*æ–¤/g, '$1 loaves')
                    .replace(/(\d+)\s*å€‹/g, '$1 pieces')
                    .replace(/(\d+)\s*ãƒ›ãƒ¼ãƒ«/g, '$1 whole cake')
                    .replace(/(\d+)\s*å°/g, '$1 cakes');
            } else {
                // English to Japanese
                return yieldText
                    .replace(/(\d+)\s*servings?/gi, '$1äººåˆ†')
                    .replace(/(\d+)\s*loaves?/gi, '$1æœ¬')
                    .replace(/(\d+)\s*pieces?/gi, '$1å€‹')
                    .replace(/(\d+)\s*cookies?/gi, '$1å€‹')
                    .replace(/(\d+)\s*whole\s*cakes?/gi, '$1ãƒ›ãƒ¼ãƒ«')
                    .replace(/(\d+)\s*cakes?/gi, '$1å°');
            }
        }

        async function getTranslatedTitle(recipeId, originalTitle) {
            const cacheKey = `${recipeId}_${currentLanguage}`;
            
            // Check if already cached
            if (titleTranslationCache[cacheKey]) {
                return titleTranslationCache[cacheKey];
            }

            // Check if translation is needed
            const titleLanguage = detectRecipeLanguage({ title: originalTitle, ingredients: [], instructions: [] });
            if (titleLanguage === currentLanguage) {
                return originalTitle; // No translation needed
            }

            // Return original title for now, and translate in background
            translateTitleInBackground(recipeId, originalTitle, cacheKey);
            return originalTitle;
        }

        async function translateTitleInBackground(recipeId, originalTitle, cacheKey) {
            try {
                const targetLanguage = currentLanguage;
                const prompt = targetLanguage === 'ja'
                    ? `Translate this recipe title to Japanese. Return ONLY the translated title, no explanations:\n\n${originalTitle}`
                    : `Translate this recipe title to English. Return ONLY the translated title, no explanations:\n\n${originalTitle}`;

                const response = await fetch(`https://api.anthropic.com/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 100,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const translatedTitle = data.content[0].text.trim().replace(/["""]/g, '');
                    
                    // Cache the translation
                    titleTranslationCache[cacheKey] = translatedTitle;
                    saveTranslationCache();
                    
                    // Re-render the specific recipe card with translated title
                    renderRecipes();
                }
            } catch (error) {
                console.error('Title translation error:', error);
            }
        }

        function adjustServings(id, change) {
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;

            const current = recipe.currentServings || recipe.baseServings;
            const newServings = Math.max(1, current + change);
            recipe.currentServings = newServings;
            renderRecipes();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('searchInput').addEventListener('input', renderRecipes);
        document.getElementById('categoryFilter').addEventListener('change', renderRecipes);
        document.getElementById('seasonFilter').addEventListener('change', renderRecipes);
        document.getElementById('eventFilter').addEventListener('change', renderRecipes);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.addEventListener('click', function(e) {
            if (e.target.id === 'recipeModal') closeModal();
            if (e.target.id === 'detailModal') closeDetailModal();
            if (e.target.id === 'importModal') closeImportModal();
            if (e.target.id === 'textImportModal') closeTextImportModal();
            if (e.target.id === 'photoImportModal') closePhotoImportModal();
        });

        // åˆæœŸè¡¨ç¤º
        document.getElementById('languageSelect').value = currentLanguage;
        applyTranslations();
        renderRecipes();

        // Export and Import functions for data sync between devices
        function exportRecipes() {
            const dataToExport = {
                recipes: recipes,
                exportDate: new Date().toISOString(),
                version: '1.0',
                appName: 'Recipe Manager'
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `recipes-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(currentLanguage === 'ja' 
                ? `âœ“ ${recipes.length}å€‹ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\n\nã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã€ŒğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’èª­è¾¼ã€ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`
                : `âœ“ Exported ${recipes.length} recipes!\n\nUse "ğŸ“¥ Import Data" on other devices to load this file.`
            );
        }

        function importRecipes(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.recipes || !Array.isArray(importedData.recipes)) {
                        throw new Error('Invalid file format');
                    }

                    // Ask user what to do with existing recipes
                    const message = currentLanguage === 'ja'
                        ? `${importedData.recipes.length}å€‹ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\n\næ—¢å­˜ã®ãƒ¬ã‚·ãƒ”ã‚’ã©ã†ã—ã¾ã™ã‹ï¼Ÿ\n\nOK = æ—¢å­˜ã®ãƒ¬ã‚·ãƒ”ã«è¿½åŠ \nã‚­ãƒ£ãƒ³ã‚»ãƒ« = æ—¢å­˜ã®ãƒ¬ã‚·ãƒ”ã‚’ç½®ãæ›ãˆ`
                        : `Import ${importedData.recipes.length} recipes.\n\nWhat to do with existing recipes?\n\nOK = Add to existing\nCancel = Replace existing`;
                    
                    const shouldMerge = confirm(message);

                    if (shouldMerge) {
                        // Merge: Add imported recipes to existing ones
                        // Check for duplicates by ID
                        const existingIds = new Set(recipes.map(r => r.id));
                        const newRecipes = importedData.recipes.filter(r => !existingIds.has(r.id));
                        recipes = [...recipes, ...newRecipes];
                        
                        const addedCount = newRecipes.length;
                        alert(currentLanguage === 'ja'
                            ? `âœ“ ${addedCount}å€‹ã®æ–°ã—ã„ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nï¼ˆ${importedData.recipes.length - addedCount}å€‹ã®é‡è¤‡ãƒ¬ã‚·ãƒ”ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸï¼‰`
                            : `âœ“ Added ${addedCount} new recipes!\n(Skipped ${importedData.recipes.length - addedCount} duplicates)`
                        );
                    } else {
                        // Replace: Overwrite all existing recipes
                        recipes = importedData.recipes;
                        alert(currentLanguage === 'ja'
                            ? `âœ“ ${recipes.length}å€‹ã®ãƒ¬ã‚·ãƒ”ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ç½®ãæ›ãˆã‚‰ã‚Œã¾ã—ãŸã€‚`
                            : `âœ“ Loaded ${recipes.length} recipes!\nExisting data was replaced.`
                        );
                    }

                    saveRecipes();
                    renderRecipes();

                } catch (error) {
                    console.error('Import error:', error);
                    alert(currentLanguage === 'ja'
                        ? 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ­£ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                        : 'âŒ Failed to load file.\nPlease check if it is a valid backup file.'
                    );
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
    </script>
</body>
</html>
